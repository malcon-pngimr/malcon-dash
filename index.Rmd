---
title: "Health Facility Survey 2021 - MalCon"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    # social: menu
    # source_code: embed
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
#------------------ Packages ------------------

# install required packages
install.packages("flexdashboard", dependencies = TRUE)
install.packages("graphite2", dependencies = TRUE)

# load required packages
library(magrittr)
library(flexdashboard)




# -------------------------------------------------------------------------
# Pulling HFS data for the MalCon Project
# Source: ODK Central - Swiss TPH
# -------------------------------------------------------------------------

# Set Global Environment --------------------------------------------------


# Set PAT_KEY
(pat_key <- Sys.getenv("PAT_KEY"))

# Set form id and url as characters
fid <- c(form1 = "hfc_v3", form2 = "pi_v3",
         form3 = "ppa_v3", form4 = "ei_v3",
         form5 = "fvs_v1")

# Set ODK form url
fid_url <- paste("https://odk-central.swisstph.ch/v1/projects/17/forms/",
                 fid, ".svc", sep = "")

# Set current raw file url from repo 
raw_url <- "raw.githubusercontent.com/myominnoo/malcon/main/data/"


# set global variables
hfc_v3 <- NULL
pi_v3 <- NULL
ppa_v3 <- NULL
ei_v3 <- NULL
fvs_v1 <- NULL



# Data pull from malcon repo ----------------------------------------------

for (x in 1:length(fid)) {
    temp_file <- tempdir()
    
    temp_file <- paste(temp_file, "/", fid[x], ".csv", sep = "")
    download.file(paste("https://", pat_key, "@", raw_url, fid[x], ".csv", sep = ""), 
                  temp_file)
    
    assign(fid[x], read.csv(temp_file, stringsAsFactors = FALSE))
}

# remove all except fid names 
rm(list = setdiff(ls(), fid))
print(ls())

hfc_v3 <- hfc_v3 %>% 
    dplyr::select(hfs_00X:hfs_010) %>%
    dplyr::mutate(hfs_00X = as.Date(sub("T.*", "", hfs_00X), format = "%Y-%m-%d"), 
           hfs_011 = as.Date(hfs_011, format = "%Y-%m-%d")) 

last_submission <- hfc_v3 %>% 
    dplyr::filter(hfs_00X == max(hfs_00X))

province_complete <- hfc_v3 %>% 
    dplyr::distinct(hfs_001A) %>% 
    dplyr::summarize(n = dplyr::n()) %>%
    unlist

print("rnaturalearth" %in% installed.packages())

#------------------ Parameters ------------------
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color
tested_color <- "purple"
positive_color <- RColorBrewer::brewer.pal(9, "PuRd")[7]
active_color <- "#1f77b4"
recovered_color <- "forestgreen"
# death_color <- "#660708"
death_color <- "red"
intensive_care_color <- "#ba181b"
h_symptoms_color <- "#e5383b"
home_conf_color <- "#FDBBBC"
```


Summary
=======================================================================
Column { data-width=150 }
-----------------------------------------------------------------------

### last Submission Date {.value-box}
```{r}
valueBox(value = last_submission$hfs_00X[1], 
         caption = "Date of last submission", 
         icon = "fas fa-calendar", 
         color = tested_color)
```

### Total Submission number {.value-box}

```{r}
valueBox(value = nrow(hfc_v3), 
         caption = "Total submission", 
         icon = "fas fa-upload", 
         color = positive_color)
```



Column { data-width=425 }
-----------------------------------------------------------------------

### Survey Progress by Province (as of `r Sys.Date()`)

```{r}
### Success Rate
gauge(
    round(province_complete/22*100, 0), min = 0, max = 100, symbol = '%', 
    label = "Total province completed: `r province_complete` / 22",
    sectors = gaugeSectors(
      danger = c(0, 20),
      warning = c(20, 80),
      success = c(80, 100)
    )
  )  
```

Column { data-width=425 }
-----------------------------------------------------------------------

### Cases Distribution by Region


Data
=======================================================================

```{r}
hfc_v3 %>% 
  DT::datatable(rownames = FALSE, 
                options = list(searchHighlight = TRUE, scrollY = '600px',
                           pageLength = nrow(hfc_v3)), filter = 'top',)
```


About
=======================================================================
**The MalCon PNGIMR Dashboard**

This [MalCon PNGIMR Dashboard](https://myominnoo.github.io/malcon-dash/) provides an overview of the progress of the health facility survey 2021 conducted by the Malaria Control Section (MalCon) at the Papua New Guinea Institute of Medical Research (PNGMIR). This dashboard is built in the framework of reproducibile research using Rmarkdown and GitHub action workflows.

**Data**

The input data for this dashboard are from the ODK Central platform that is hosted by Swiss Tropical and Public Health Institute. The data and dashboard are refreshed on a daily basis.

**Packages**

- Dashboard interface - the flexdashboard package.
- Visualization - the plotly package for the plots and mapview package for the map
- Data manipulation - dplyr, and tidyr
- Tables - the DT package
